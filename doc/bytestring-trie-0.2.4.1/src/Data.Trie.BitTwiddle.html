<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -Wall -fwarn-tabs -fno-warn-name-shadowing #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-- The MagicHash is for unboxed primitives (-fglasgow-exts also works)</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE CPP, MagicHash #-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><a name="line-7"></a><span class="hs-comment">--                                                  ~ 2009.01.05</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Module      :  Data.Trie.BitTwiddle</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Copyright   :  Copyright (c) 2002 Daan Leijen</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- License     :  BSD3</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Maintainer  :  libraries@haskell.org, wren@community.haskell.org</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- Stability   :  stable</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- Portability :  portable (with CPP)</span><span>
</span><a name="line-15"></a><span class="hs-comment">--</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- Functions to treat 'Word' as a bit-vector for big-endian patricia</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- trees. This code is duplicated from &quot;Data.IntMap&quot;. The only</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- differences are that some of the conversion functions are</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- specialized to 'Word8' for bytestrings, instead of being specialized</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- to 'Int'.</span><span>
</span><a name="line-21"></a><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Trie</span><span class="hs-operator">.</span><span class="hs-identifier">BitTwiddle</span><span>
</span><a name="line-24"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="Data.Trie.BitTwiddle.html#Prefix"><span class="hs-identifier hs-type">Prefix</span></a><span class="hs-special">,</span><span> </span><a href="Data.Trie.BitTwiddle.html#Mask"><span class="hs-identifier hs-type">Mask</span></a><span>
</span><a name="line-25"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Trie.BitTwiddle.html#elemToNat"><span class="hs-identifier hs-var">elemToNat</span></a><span>
</span><a name="line-26"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Trie.BitTwiddle.html#zero"><span class="hs-identifier hs-var">zero</span></a><span class="hs-special">,</span><span> </span><a href="Data.Trie.BitTwiddle.html#nomatch"><span class="hs-identifier hs-var">nomatch</span></a><span>
</span><a name="line-27"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Trie.BitTwiddle.html#mask"><span class="hs-identifier hs-var">mask</span></a><span class="hs-special">,</span><span> </span><a href="Data.Trie.BitTwiddle.html#shorter"><span class="hs-identifier hs-var">shorter</span></a><span class="hs-special">,</span><span> </span><a href="Data.Trie.BitTwiddle.html#branchMask"><span class="hs-identifier hs-var">branchMask</span></a><span>
</span><a name="line-28"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Trie.ByteStringInternal.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Trie</span><span class="hs-operator">.</span><span class="hs-identifier">ByteStringInternal</span></a><span> </span><span class="hs-special">(</span><a href="Data.Trie.ByteStringInternal.html#ByteStringElem"><span class="hs-identifier hs-type">ByteStringElem</span></a><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bits</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &gt;= 503</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Exts</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Word</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">shiftRL</span><span class="hs-operator hs-var">#</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-cpp">#elif __GLASGOW_HASKELL__</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GlaExts</span><span>   </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">Word</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Int</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">shiftRL</span><span class="hs-operator">#</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Word</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Word</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-keyword">type</span><span> </span><a name="KeyElem"><a href="Data.Trie.BitTwiddle.html#KeyElem"><span class="hs-identifier">KeyElem</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Trie.ByteStringInternal.html#ByteStringElem"><span class="hs-identifier hs-type">ByteStringElem</span></a><span> </span><span>
</span><a name="line-45"></a><span class="hs-keyword">type</span><span> </span><a name="Prefix"><a href="Data.Trie.BitTwiddle.html#Prefix"><span class="hs-identifier">Prefix</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Trie.BitTwiddle.html#KeyElem"><span class="hs-identifier hs-type">KeyElem</span></a><span> </span><span>
</span><a name="line-46"></a><span class="hs-keyword">type</span><span> </span><a name="Mask"><a href="Data.Trie.BitTwiddle.html#Mask"><span class="hs-identifier">Mask</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Trie.BitTwiddle.html#KeyElem"><span class="hs-identifier hs-type">KeyElem</span></a><span> </span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-identifier">elemToNat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Trie.BitTwiddle.html#KeyElem"><span class="hs-identifier hs-type">KeyElem</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word</span><span>
</span><a name="line-49"></a><span class="hs-pragma">{-# INLINE elemToNat #-}</span><span>
</span><a name="line-50"></a><a name="elemToNat"><a href="Data.Trie.BitTwiddle.html#elemToNat"><span class="hs-identifier">elemToNat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-identifier">natToElem</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Trie.BitTwiddle.html#KeyElem"><span class="hs-identifier hs-type">KeyElem</span></a><span>
</span><a name="line-53"></a><span class="hs-pragma">{-# INLINE natToElem #-}</span><span>
</span><a name="line-54"></a><a name="natToElem"><a href="Data.Trie.BitTwiddle.html#natToElem"><span class="hs-identifier">natToElem</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-identifier">shiftRL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word</span><span>
</span><a name="line-57"></a><span class="hs-pragma">{-# INLINE shiftRL #-}</span><span>
</span><a name="line-58"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- GHC: use unboxing to get @shiftRL@ inlined.</span><span>
</span><a name="line-60"></a><a name="shiftRL"><a href="Data.Trie.BitTwiddle.html#shiftRL"><span class="hs-identifier">shiftRL</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">W</span><span class="hs-operator hs-var">#</span><span> </span><a name="local-6989586621679031135"><a href="#local-6989586621679031135"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span class="hs-operator hs-var">#</span><span> </span><a name="local-6989586621679031136"><a href="#local-6989586621679031136"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">W</span><span class="hs-operator hs-var">#</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">shiftRL</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679031135"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679031136"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-62"></a><span class="hs-identifier">shiftRL</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">shiftR</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-identifier">i</span><span>
</span><a name="line-63"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-comment">{---------------------------------------------------------------
-- Endian independent bit twiddling (Trie endianness, not architecture)
---------------------------------------------------------------}</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-comment">-- TODO: should we use the (Bits Word8) instance instead of 'elemToNat' and (Bits Nat)? We need to compare Core, C--, or ASM in order to decide this. The choice will apply to 'zero', 'mask', 'maskW',... If we shouldn't, then we should probably send a patch upstream to fix the (Bits Word8) instance.</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-comment">-- | Is the value under the mask zero?</span><span>
</span><a name="line-73"></a><span class="hs-identifier">zero</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Trie.BitTwiddle.html#KeyElem"><span class="hs-identifier hs-type">KeyElem</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Trie.BitTwiddle.html#Mask"><span class="hs-identifier hs-type">Mask</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-74"></a><span class="hs-pragma">{-# INLINE zero #-}</span><span>
</span><a name="line-75"></a><a name="zero"><a href="Data.Trie.BitTwiddle.html#zero"><span class="hs-identifier">zero</span></a></a><span> </span><a name="local-6989586621679031137"><a href="#local-6989586621679031137"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679031138"><a href="#local-6989586621679031138"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Data.Trie.BitTwiddle.html#elemToNat"><span class="hs-identifier hs-var">elemToNat</span></a><span> </span><a href="#local-6989586621679031137"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><span class="hs-special">(</span><a href="Data.Trie.BitTwiddle.html#elemToNat"><span class="hs-identifier hs-var">elemToNat</span></a><span> </span><a href="#local-6989586621679031138"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-comment">-- | Does a value /not/ match some prefix, for all the bits preceding</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- a masking bit? (Hence a subtree matching the value doesn't exist.)</span><span>
</span><a name="line-79"></a><span class="hs-identifier">nomatch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Trie.BitTwiddle.html#KeyElem"><span class="hs-identifier hs-type">KeyElem</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Trie.BitTwiddle.html#Prefix"><span class="hs-identifier hs-type">Prefix</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Trie.BitTwiddle.html#Mask"><span class="hs-identifier hs-type">Mask</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-80"></a><span class="hs-pragma">{-# INLINE nomatch #-}</span><span>
</span><a name="line-81"></a><a name="nomatch"><a href="Data.Trie.BitTwiddle.html#nomatch"><span class="hs-identifier">nomatch</span></a></a><span> </span><a name="local-6989586621679031139"><a href="#local-6989586621679031139"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679031140"><a href="#local-6989586621679031140"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679031141"><a href="#local-6989586621679031141"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Trie.BitTwiddle.html#mask"><span class="hs-identifier hs-var">mask</span></a><span> </span><a href="#local-6989586621679031139"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679031141"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679031140"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-identifier">mask</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Trie.BitTwiddle.html#KeyElem"><span class="hs-identifier hs-type">KeyElem</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Trie.BitTwiddle.html#Mask"><span class="hs-identifier hs-type">Mask</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Trie.BitTwiddle.html#Prefix"><span class="hs-identifier hs-type">Prefix</span></a><span>
</span><a name="line-84"></a><span class="hs-pragma">{-# INLINE mask #-}</span><span>
</span><a name="line-85"></a><a name="mask"><a href="Data.Trie.BitTwiddle.html#mask"><span class="hs-identifier">mask</span></a></a><span> </span><a name="local-6989586621679031142"><a href="#local-6989586621679031142"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679031143"><a href="#local-6989586621679031143"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Trie.BitTwiddle.html#maskW"><span class="hs-identifier hs-var">maskW</span></a><span> </span><span class="hs-special">(</span><a href="Data.Trie.BitTwiddle.html#elemToNat"><span class="hs-identifier hs-var">elemToNat</span></a><span> </span><a href="#local-6989586621679031142"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Trie.BitTwiddle.html#elemToNat"><span class="hs-identifier hs-var">elemToNat</span></a><span> </span><a href="#local-6989586621679031143"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-comment">{---------------------------------------------------------------
-- Big endian operations (Trie endianness, not architecture)
---------------------------------------------------------------}</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-comment">-- | Get mask by setting all bits higher than the smallest bit in</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- @m@. Then apply that mask to @i@.</span><span>
</span><a name="line-94"></a><span class="hs-identifier">maskW</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Trie.BitTwiddle.html#Prefix"><span class="hs-identifier hs-type">Prefix</span></a><span>
</span><a name="line-95"></a><span class="hs-pragma">{-# INLINE maskW #-}</span><span>
</span><a name="line-96"></a><a name="maskW"><a href="Data.Trie.BitTwiddle.html#maskW"><span class="hs-identifier">maskW</span></a></a><span> </span><a name="local-6989586621679031144"><a href="#local-6989586621679031144"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679031145"><a href="#local-6989586621679031145"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Trie.BitTwiddle.html#natToElem"><span class="hs-identifier hs-var">natToElem</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031144"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">complement</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031145"><span class="hs-identifier hs-var">m</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xor</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679031145"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- TODO: try the alternatives mentioned in the Containers paper:</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- \i m -&gt; natToElem (i .&amp;. (negate m - m))</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- \i m -&gt; natToElem (i .&amp;. (m * complement 1))</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- N.B. these return /all/ the low bits, and therefore they are not equal functions for all m. They are, however, equal when only one bit of m is set.</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- | Determine whether the first mask denotes a shorter prefix than</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- the second.</span><span>
</span><a name="line-104"></a><span class="hs-identifier">shorter</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Trie.BitTwiddle.html#Mask"><span class="hs-identifier hs-type">Mask</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Trie.BitTwiddle.html#Mask"><span class="hs-identifier hs-type">Mask</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-105"></a><span class="hs-pragma">{-# INLINE shorter #-}</span><span>
</span><a name="line-106"></a><a name="shorter"><a href="Data.Trie.BitTwiddle.html#shorter"><span class="hs-identifier">shorter</span></a></a><span> </span><a name="local-6989586621679031146"><a href="#local-6989586621679031146"><span class="hs-identifier">m1</span></a></a><span> </span><a name="local-6989586621679031147"><a href="#local-6989586621679031147"><span class="hs-identifier">m2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Trie.BitTwiddle.html#elemToNat"><span class="hs-identifier hs-var">elemToNat</span></a><span> </span><a href="#local-6989586621679031146"><span class="hs-identifier hs-var">m1</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="Data.Trie.BitTwiddle.html#elemToNat"><span class="hs-identifier hs-var">elemToNat</span></a><span> </span><a href="#local-6989586621679031147"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">-- | Determine first differing bit of two prefixes.</span><span>
</span><a name="line-109"></a><span class="hs-identifier">branchMask</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Trie.BitTwiddle.html#Prefix"><span class="hs-identifier hs-type">Prefix</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Trie.BitTwiddle.html#Prefix"><span class="hs-identifier hs-type">Prefix</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Trie.BitTwiddle.html#Mask"><span class="hs-identifier hs-type">Mask</span></a><span>
</span><a name="line-110"></a><span class="hs-pragma">{-# INLINE branchMask #-}</span><span>
</span><a name="line-111"></a><a name="branchMask"><a href="Data.Trie.BitTwiddle.html#branchMask"><span class="hs-identifier">branchMask</span></a></a><span> </span><a name="local-6989586621679031148"><a href="#local-6989586621679031148"><span class="hs-identifier">p1</span></a></a><span> </span><a name="local-6989586621679031149"><a href="#local-6989586621679031149"><span class="hs-identifier">p2</span></a></a><span>
</span><a name="line-112"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Trie.BitTwiddle.html#natToElem"><span class="hs-identifier hs-var">natToElem</span></a><span> </span><span class="hs-special">(</span><a href="Data.Trie.BitTwiddle.html#highestBitMask"><span class="hs-identifier hs-var">highestBitMask</span></a><span> </span><span class="hs-special">(</span><a href="Data.Trie.BitTwiddle.html#elemToNat"><span class="hs-identifier hs-var">elemToNat</span></a><span> </span><a href="#local-6989586621679031148"><span class="hs-identifier hs-var">p1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xor</span><span class="hs-special">`</span><span> </span><a href="Data.Trie.BitTwiddle.html#elemToNat"><span class="hs-identifier hs-var">elemToNat</span></a><span> </span><a href="#local-6989586621679031149"><span class="hs-identifier hs-var">p2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-comment">{---------------------------------------------------------------
  Finding the highest bit (mask) in a word [x] can be done efficiently
  in three ways:
  * convert to a floating point value and the mantissa tells us the
    [log2(x)] that corresponds with the highest bit position. The
    mantissa is retrieved either via the standard C function [frexp]
    or by some bit twiddling on IEEE compatible numbers (float).
    Note that one needs to use at least [double] precision for an
    accurate mantissa of 32 bit numbers.
  * use bit twiddling, a logarithmic sequence of bitwise or's and
    shifts (bit).
  * use processor specific assembler instruction (asm).

  The most portable way would be [bit], but is it efficient enough?
  I have measured the cycle counts of the different methods on an
  AMD Athlon-XP 1800 (~ Pentium III 1.8Ghz) using the RDTSC
  instruction:

  highestBitMask: method  cycles
                  --------------
                   frexp   200
                   float    33
                   bit      11
                   asm      12

  highestBit:     method  cycles
                  --------------
                   frexp   195
                   float    33
                   bit      11
                   asm      11

  Wow, the bit twiddling is on today's RISC like machines even
  faster than a single CISC instruction (BSR)!
---------------------------------------------------------------}</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-comment">{---------------------------------------------------------------
  [highestBitMask] returns a word where only the highest bit is
  set. It is found by first setting all bits in lower positions
  than the highest bit and than taking an exclusive or with the
  original value. Allthough the function may look expensive, GHC
  compiles this into excellent C code that subsequently compiled
  into highly efficient machine code. The algorithm is derived from
  Jorg Arndt's FXT library.
---------------------------------------------------------------}</span><span>
</span><a name="line-159"></a><span class="hs-identifier">highestBitMask</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word</span><span>
</span><a name="line-160"></a><span class="hs-pragma">{-# INLINE highestBitMask #-}</span><span>
</span><a name="line-161"></a><a name="highestBitMask"><a href="Data.Trie.BitTwiddle.html#highestBitMask"><span class="hs-identifier">highestBitMask</span></a></a><span> </span><a name="local-6989586621679031150"><a href="#local-6989586621679031150"><span class="hs-identifier">x</span></a></a><span>
</span><a name="line-162"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031150"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.|.</span><span> </span><a href="Data.Trie.BitTwiddle.html#shiftRL"><span class="hs-identifier hs-var">shiftRL</span></a><span> </span><a href="#local-6989586621679031150"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><a name="line-163"></a><span>       </span><a name="local-6989586621679031151"><a href="#local-6989586621679031151"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031151"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.|.</span><span> </span><a href="Data.Trie.BitTwiddle.html#shiftRL"><span class="hs-identifier hs-var">shiftRL</span></a><span> </span><a href="#local-6989586621679031151"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><a name="line-164"></a><span>        </span><a name="local-6989586621679031152"><a href="#local-6989586621679031152"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031152"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.|.</span><span> </span><a href="Data.Trie.BitTwiddle.html#shiftRL"><span class="hs-identifier hs-var">shiftRL</span></a><span> </span><a href="#local-6989586621679031152"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-number">4</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><a name="line-165"></a><span>         </span><a name="local-6989586621679031153"><a href="#local-6989586621679031153"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031153"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.|.</span><span> </span><a href="Data.Trie.BitTwiddle.html#shiftRL"><span class="hs-identifier hs-var">shiftRL</span></a><span> </span><a href="#local-6989586621679031153"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-number">8</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><a name="line-166"></a><span>          </span><a name="local-6989586621679031154"><a href="#local-6989586621679031154"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031154"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.|.</span><span> </span><a href="Data.Trie.BitTwiddle.html#shiftRL"><span class="hs-identifier hs-var">shiftRL</span></a><span> </span><a href="#local-6989586621679031154"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-number">16</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><a name="line-167"></a><span>           </span><a name="local-6989586621679031155"><a href="#local-6989586621679031155"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031155"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.|.</span><span> </span><a href="Data.Trie.BitTwiddle.html#shiftRL"><span class="hs-identifier hs-var">shiftRL</span></a><span> </span><a href="#local-6989586621679031155"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-number">32</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>   </span><span class="hs-comment">-- for 64 bit platforms</span><span>
</span><a name="line-168"></a><span>            </span><a name="local-6989586621679031156"><a href="#local-6989586621679031156"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031156"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xor</span><span class="hs-special">`</span><span> </span><a href="Data.Trie.BitTwiddle.html#shiftRL"><span class="hs-identifier hs-var">shiftRL</span></a><span> </span><a href="#local-6989586621679031156"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><a name="line-171"></a><span class="hs-comment">----------------------------------------------------------- fin.</span><span>
</span><a name="line-172"></a></pre></body></html>